name: Dependabot PR Validation

# âš ï¸ ARCHITECTURE TRANSITION NOTICE:
# This workflow will be updated for Redis pub/sub architecture
# Current HTTP-based tests will be replaced with Redis connectivity validation

on:
  pull_request:
    types: [opened, synchronize]
    # Only run on dependabot PRs
    branches: [main]

jobs:
  # Check if this is a dependabot PR
  check-dependabot:
    runs-on: ubuntu-latest
    outputs:
      is-dependabot: ${{ steps.check.outputs.is-dependabot }}
    steps:
      - name: Check if dependabot PR
        id: check
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is-dependabot=true" >> $GITHUB_OUTPUT
          else
            echo "is-dependabot=false" >> $GITHUB_OUTPUT
          fi

  # Validate docker-compose configuration
  validate-compose:
    needs: check-dependabot
    if: needs.check-dependabot.outputs.is-dependabot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create minimal .env file for validation
        run: |
          echo "Creating minimal .env file for docker-compose validation..."
          cat > .env << 'EOF'
          # Minimal .env file for CI validation
          FOGIS_USERNAME=ci_test_user
          FOGIS_PASSWORD=ci_test_password
          NOTIFICATIONS_ENABLED=false
          EMAIL_ENABLED=false
          SMTP_HOST=smtp.example.com
          SMTP_PORT=587
          SMTP_USERNAME=test@example.com
          SMTP_PASSWORD=test_password
          SMTP_FROM=noreply@example.com
          SMTP_USE_TLS=true
          DISCORD_ENABLED=false
          DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/test
          DISCORD_BOT_USERNAME=FOGIS Bot
          EOF
          echo "âœ… .env file created"

      - name: Validate docker-compose syntax
        run: |
          docker compose config --quiet
          echo "âœ… Docker-compose configuration is valid"

      - name: Check image accessibility
        run: |
          # Extract image names from docker-compose.yml (excluding commented lines)
          images=$(grep -E "^\s*image: ghcr.io/pitchconnect/" docker-compose.yml | awk '{print $2}')

          for image in $images; do
            echo "ðŸ” Checking accessibility of $image"
            if docker manifest inspect "$image" > /dev/null 2>&1; then
              echo "âœ… $image is accessible"
            else
              echo "âŒ $image is not accessible"
              exit 1
            fi
          done

  # Test service startup and health checks
  test-service-startup:
    needs: [check-dependabot, validate-compose]
    if: needs.check-dependabot.outputs.is-dependabot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create test environment file
        run: |
          cat > .env << EOF
          # Test environment variables
          FOGIS_USERNAME=test_user
          FOGIS_PASSWORD=test_password
          GOOGLE_CREDENTIALS_PATH=/app/credentials/test-credentials.json
          GRAFANA_ADMIN_PASSWORD=test_admin
          # Notification settings (required by docker-compose.yml)
          NOTIFICATIONS_ENABLED=false
          EMAIL_ENABLED=false
          SMTP_HOST=smtp.example.com
          SMTP_PORT=587
          SMTP_USERNAME=test@example.com
          SMTP_PASSWORD=test_password
          SMTP_FROM=noreply@example.com
          SMTP_USE_TLS=true
          DISCORD_ENABLED=false
          DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/test
          DISCORD_BOT_USERNAME=FOGIS Bot
          EOF

      - name: Create test credentials and directories
        run: |
          # Create credentials directory
          mkdir -p credentials
          echo '{"type": "service_account", "project_id": "test"}' > credentials/google-credentials.json

          # Create data and log directories for all services
          # This prevents permission errors when services try to write logs
          mkdir -p data/fogis-api-client
          mkdir -p data/process-matches-service
          mkdir -p data/fogis-calendar-phonebook-sync
          mkdir -p data/fogis-calendar-phonebook-sync/google-calendar
          mkdir -p data/team-logo-combiner
          mkdir -p data/google-drive-service
          mkdir -p logs/fogis-api-client
          mkdir -p logs/process-matches-service
          mkdir -p logs/fogis-calendar-phonebook-sync
          mkdir -p logs/team-logo-combiner
          mkdir -p logs/google-drive-service

          # Set permissions to allow containers to write
          chmod -R 777 data logs

          echo "âœ… Created all required directories with proper permissions"

      - name: Start services with timeout
        run: |
          # Disable file logging in CI environment to avoid permission issues
          # Services will log to console only, which is captured by docker compose logs
          export LOG_ENABLE_FILE=false
          export LOG_ENABLE_CONSOLE=true

          # Start services in background
          timeout 300 docker compose up -d || {
            echo "âŒ Services failed to start within 5 minutes"
            docker compose logs
            exit 1
          }

      - name: Wait for health checks
        run: |
          echo "â³ Waiting for services to become healthy..."

          # Wait up to 5 minutes for all services with health checks to be healthy
          # Note: Some services (like promtail) don't have health checks and should be ignored
          timeout 300 bash -c '
            while true; do
              # Count services that are healthy
              healthy_count=$(docker compose ps --format json | jq -r ".Health" | grep -c "healthy" || echo "0")

              # Count services that have health checks defined (not empty Health field)
              # Services without health checks will have empty Health field
              services_with_healthcheck=$(docker compose ps --format json | jq -r "select(.Health != \"\") | .Service" | wc -l)

              echo "Healthy services: $healthy_count/$services_with_healthcheck"

              if [ "$healthy_count" -eq "$services_with_healthcheck" ] && [ "$services_with_healthcheck" -gt 0 ]; then
                echo "âœ… All services with health checks are healthy"
                break
              fi

              sleep 10
            done
          ' || {
            echo "âŒ Not all services became healthy within timeout"
            echo ""
            echo "Service status:"
            docker compose ps
            echo ""
            echo "Services without health checks (expected to show 'Up' without 'healthy'):"
            docker compose ps --format json | jq -r 'select(.Health == "") | .Service' || echo "None"
            echo ""
            echo "Recent logs:"
            docker compose logs --tail=50
            exit 1
          }

      - name: Test service connectivity
        run: |
          echo "ðŸ”— Testing inter-service connectivity..."

          # Test API client health (port 9086 on host -> 8080 in container)
          curl -f http://localhost:9086/health || {
            echo "âŒ FOGIS API client health check failed"
            exit 1
          }

          # Test match processor health (port 9082 on host -> 8000 in container)
          curl -f http://localhost:9082/health/simple || {
            echo "âŒ Match processor health check failed"
            exit 1
          }

          # Test calendar sync health (port 9083 on host -> 5003 in container)
          curl -f http://localhost:9083/health || {
            echo "âŒ Calendar sync health check failed"
            exit 1
          }

          echo "âœ… All service health checks passed"

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f

  # Test basic workflow functionality
  test-workflow-integration:
    needs: [check-dependabot, test-service-startup]
    if: needs.check-dependabot.outputs.is-dependabot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup test environment
        run: |
          # Create minimal test environment
          cat > .env << EOF
          FOGIS_USERNAME=test_user
          FOGIS_PASSWORD=test_password
          GOOGLE_CREDENTIALS_PATH=/app/credentials/test-credentials.json
          GRAFANA_ADMIN_PASSWORD=test_admin
          EOF

          mkdir -p credentials
          echo '{"type": "service_account", "project_id": "test"}' > credentials/google-credentials.json

      - name: Start services
        run: |
          docker compose up -d

          # Wait for services to be ready
          sleep 60

      - name: Test API endpoints
        run: |
          echo "ðŸ§ª Testing API endpoints..."

          # Test match processor health endpoint (port 9082 on host)
          # Using /health/simple as defined in docker-compose.yml healthcheck
          response=$(curl -s http://localhost:9082/health/simple)
          echo "Match processor health: $response"

          # Verify response contains expected fields
          echo "$response" | jq -e '.status' || {
            echo "âŒ Match processor health response missing status field"
            exit 1
          }

      - name: Test service dependencies
        run: |
          echo "ðŸ”— Testing service dependencies..."

          # Test that match processor health endpoint is accessible (port 9082 on host)
          # Note: The /health/simple endpoint provides basic health status
          # Dependencies are checked implicitly through service health checks
          deps_response=$(curl -s http://localhost:9082/health/simple)
          echo "Service health: $deps_response"

          # Verify service is responding
          echo "$deps_response" | jq -e '.status' || {
            echo "âŒ Service health check failed"
            exit 1
          }

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f

  # Performance regression test
  test-performance:
    needs: [check-dependabot, test-workflow-integration]
    if: needs.check-dependabot.outputs.is-dependabot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup and start services
        run: |
          cat > .env << EOF
          # Test environment variables
          FOGIS_USERNAME=test_user
          FOGIS_PASSWORD=test_password
          GOOGLE_CREDENTIALS_PATH=/app/credentials/test-credentials.json
          GRAFANA_ADMIN_PASSWORD=test_admin
          # Notification settings (required by docker-compose.yml)
          NOTIFICATIONS_ENABLED=false
          EMAIL_ENABLED=false
          SMTP_HOST=smtp.example.com
          SMTP_PORT=587
          SMTP_USERNAME=test@example.com
          SMTP_PASSWORD=test_password
          SMTP_FROM=noreply@example.com
          SMTP_USE_TLS=true
          DISCORD_ENABLED=false
          DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/test
          DISCORD_BOT_USERNAME=FOGIS Bot
          EOF

          mkdir -p credentials
          echo '{"type": "service_account", "project_id": "test"}' > credentials/google-credentials.json

          # Create data and log directories for all services
          mkdir -p data/fogis-api-client data/process-matches-service data/fogis-calendar-phonebook-sync
          mkdir -p data/fogis-calendar-phonebook-sync/google-calendar data/team-logo-combiner data/google-drive-service
          mkdir -p logs/fogis-api-client logs/process-matches-service logs/fogis-calendar-phonebook-sync
          mkdir -p logs/team-logo-combiner logs/google-drive-service
          chmod -R 777 data logs

          # Disable file logging in CI
          export LOG_ENABLE_FILE=false
          export LOG_ENABLE_CONSOLE=true

          docker compose up -d
          sleep 60

      - name: Measure startup time
        run: |
          echo "â±ï¸ Measuring service startup performance..."

          # Record startup times
          start_time=$(date +%s)

          # Wait for all services with health checks to be healthy
          # Note: Some services (like promtail) don't have health checks and should be ignored
          timeout 300 bash -c '
            while true; do
              # Count services that are healthy
              healthy_count=$(docker compose ps --format json | jq -r ".Health" | grep -c "healthy" || echo "0")

              # Count services that have health checks defined (not empty Health field)
              services_with_healthcheck=$(docker compose ps --format json | jq -r "select(.Health != \"\") | .Service" | wc -l)

              if [ "$healthy_count" -eq "$services_with_healthcheck" ] && [ "$services_with_healthcheck" -gt 0 ]; then
                break
              fi
              sleep 5
            done
          '

          end_time=$(date +%s)
          startup_duration=$((end_time - start_time))

          echo "ðŸ• Total startup time: ${startup_duration} seconds"

          # Fail if startup takes longer than 5 minutes
          if [ $startup_duration -gt 300 ]; then
            echo "âŒ Startup time exceeded 5 minutes threshold"
            exit 1
          fi

          echo "âœ… Startup performance within acceptable range"

      - name: Test response times
        run: |
          echo "ðŸš€ Testing API response times..."

          # Test match processor response time (port 9082 on host)
          response_time=$(curl -w "%{time_total}" -s -o /dev/null http://localhost:9082/health/simple)
          echo "Match processor response time: ${response_time}s"

          # Fail if response time > 5 seconds
          if (( $(echo "$response_time > 5.0" | bc -l) )); then
            echo "âŒ Response time too slow: ${response_time}s"
            exit 1
          fi

          echo "âœ… Response times within acceptable range"

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f

  # Final validation summary
  validation-summary:
    needs: [validate-compose, test-service-startup, test-workflow-integration, test-performance]
    if: always() && needs.check-dependabot.outputs.is-dependabot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Validation Summary
        run: |
          echo "## ðŸ§ª Dependabot PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.validate-compose.result }}" == "success" ]]; then
            echo "âœ… **Docker Compose Validation**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Docker Compose Validation**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.test-service-startup.result }}" == "success" ]]; then
            echo "âœ… **Service Startup Test**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Service Startup Test**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.test-workflow-integration.result }}" == "success" ]]; then
            echo "âœ… **Workflow Integration Test**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Workflow Integration Test**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.test-performance.result }}" == "success" ]]; then
            echo "âœ… **Performance Test**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Performance Test**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for merge**: All validation tests passed âœ…" >> $GITHUB_STEP_SUMMARY
